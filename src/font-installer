#!/usr/bin/env python3

import sys
import os
import shutil
import subprocess
from pathlib import Path
from PySide6.QtWidgets import (QApplication, QMainWindow, QMessageBox, 
                               QProgressDialog)
from PySide6.QtUiTools import QUiLoader
from PySide6.QtCore import QFile, Qt
from PySide6.QtGui import QFontDatabase, QFont, QIcon

class FontInstallerApp(QMainWindow):
    def __init__(self, font_path):
        super().__init__()
        self.font_path = Path(font_path)
        
        if not self.font_path.exists() or not self.font_path.is_file():
            QMessageBox.critical(None, "Erro", "Arquivo de fonte inválido ou não encontrado.")
            sys.exit(1)

        self.load_ui()
        self.populate_data()
    
        self.ui.btn_cancel.clicked.connect(self.close)
        self.ui.btn_install.clicked.connect(self.install_font)

    def load_ui(self):
        loader = QUiLoader()
        ui_file = QFile("font-installer.ui")
        if not ui_file.open(QFile.ReadOnly):
            print("Não foi possível abrir o arquivo installer.ui")
            sys.exit(-1)
        self.ui = loader.load(ui_file)
        ui_file.close()
        
        self.setCentralWidget(self.ui)
        self.setWindowTitle(f"Instalador de fontes do Aratiê - {self.font_path.name}")
        self.resize(650, 450)
        
        if QIcon.hasThemeIcon("font-x-generic"):
            self.setWindowIcon(QIcon.fromTheme("font-x-generic"))

    def get_fc_scan_data(self):
        try:
            cmd = [
                'fc-scan', 
                '--format', 
                "n:%{fullname}\ns:%{style}\nt:%{fontformat}\nf:%{family}\nd:%{foundry}\n", 
                str(self.font_path)
            ]
            result = subprocess.run(cmd, capture_output=True, text=True, check=True)
            output = result.stdout
            
            data = {}
            for line in output.splitlines():
                if line.startswith("n:"): data['name'] = line[2:]
                elif line.startswith("s:"): data['style'] = line[2:]
                elif line.startswith("t:"): data['type'] = line[2:]
                elif line.startswith("f:"): data['family'] = line[2:]
                elif line.startswith("d:"): data['foundry'] = line[2:]
            
            return data
        except subprocess.CalledProcessError:
            return None

    def populate_data(self):
        font_id = QFontDatabase.addApplicationFont(str(self.font_path))
        
        if font_id == -1:
            QMessageBox.warning(self, "Aviso", "O arquivo não parece ser uma fonte válida para o Qt.")
        else:
            font_families = QFontDatabase.applicationFontFamilies(font_id)
            if font_families:
                custom_font = QFont(font_families[0], 48)
                self.ui.lbl_preview.setFont(custom_font)
        
        meta = self.get_fc_scan_data()
        
        if meta:
            self.ui.val_nome.setText(meta.get('name', 'Desconhecido'))
            self.ui.val_estilo.setText(meta.get('style', 'Regular'))
            self.ui.val_tipo.setText(meta.get('type', 'Desconhecido'))
            fam = meta.get('family', 'Desconhecido')
            self.ui.val_familia.setText(f"{fam}") 
            self.ui.val_fundacao.setText(meta.get('foundry', 'NONE'))
        else:
            self.ui.val_nome.setText("Erro ao ler metadados")

    def install_font(self):
        dest_dir = Path.home() / ".local/share/fonts"
        dest_dir.mkdir(parents=True, exist_ok=True)
        
        dest_file = dest_dir / self.font_path.name
        
        try:
            shutil.copy2(self.font_path, dest_file)
            
            progress = QProgressDialog("Atualizando cache de fontes...", "Cancelar", 0, 0, self)
            progress.setWindowModality(Qt.WindowModal)
            progress.show()
            QApplication.processEvents()
            
            subprocess.run(['fc-cache', '-f', '-v'], check=True, stdout=subprocess.DEVNULL)
            
            progress.close()
            
            QMessageBox.information(self, "Sucesso", f"A fonte {self.font_path.name} foi instalada com sucesso!")
            self.close()
            
        except Exception as e:
            QMessageBox.critical(self, "Erro", f"Falha na instalação:\n{str(e)}")

if __name__ == "__main__":
    app = QApplication(sys.argv)
    
    if len(sys.argv) < 2:
        print("Uso: font-instakker <arquivo-de-fonte>")
        
        dummy_font = "minha_fonte.ttf" 
        if not os.path.exists(dummy_font):
             QMessageBox.critical(None, "Erro", "Por favor forneça um arquivo de fonte como argumento.")
             sys.exit(1)
    else:
        font_file = sys.argv[1]

    window = FontInstallerApp(font_file)
    window.show()
    
    sys.exit(app.exec())
